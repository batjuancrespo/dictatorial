<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Informes Radiológicos</title>
    <style>
        /* --- CSS Unificado (Basado en style.css) --- */
        :root {
            --bg-primary: #f4f8fa; --bg-secondary: #ffffff; --text-primary: #2f363d; --text-secondary: #5c6975; --border-color: #d0d7de; --border-light-color: #e9ecef; --accent-color: #007bff; --accent-text-color: #ffffff;
            --btn-record-bg: #28a745; --btn-record-bg-hover: #218838; --btn-stop-bg: #dc3545; --btn-stop-bg-hover: #c82333; --btn-copy-bg: #fd7e14; --btn-copy-bg-hover: #e66f0d; --btn-copy-text: #ffffff; --btn-success-bg: var(--btn-record-bg); --btn-success-bg-hover: var(--btn-record-bg-hover); --btn-danger-bg: var(--btn-stop-bg); --btn-danger-bg-hover: var(--btn-stop-bg-hover);
            --input-bg: #ffffff; --input-border: #ced4da; --input-text: #2f363d;
            --switch-bg: #ccc; --switch-thumb-bg: white; --switch-checked-bg: #007bff;
            --juanizador-accent-color: var(--btn-danger-bg);
            --juanizador-secondary-color: var(--accent-color);
            --juanizador-primary-color: var(--text-primary);
            --juanizador-dark-color: #0056b3; /* Darker primary for hover */
            --accent-color-rgb: 0, 123, 255;
        }

        body[data-theme="dark"] {
            --bg-primary: #22272e; --bg-secondary: #2d333b; --text-primary: #adbac7; --text-secondary: #768390; --border-color: #444c56; --border-light-color: #373e47; --accent-color: #539bf5; --accent-text-color: #ffffff;
            --btn-record-bg: #377ef0; --btn-record-bg-hover: #539bf5; --btn-stop-bg: #e5534b; --btn-stop-bg-hover: #f47067; --btn-copy-bg: #d9971a; --btn-copy-bg-hover: #f0b72f; --btn-copy-text: #22272e; --btn-success-bg: #28a745; --btn-success-bg-hover: #218838; --btn-danger-bg: var(--btn-stop-bg); --btn-danger-bg-hover: var(--btn-stop-bg-hover);
            --input-bg: #22272e; --input-border: #444c56; --input-text: #adbac7;
            --switch-bg: #444c56; --switch-thumb-bg: #768390; --switch-checked-bg: #377ef0;
            --juanizador-accent-color: var(--btn-danger-bg);
            --juanizador-secondary-color: var(--accent-color);
            --juanizador-primary-color: var(--text-primary);
            --juanizador-dark-color: #2188ff; /* Darker primary for hover in dark mode */
            --accent-color-rgb: 83, 155, 245;
        }

        /* --- Estructura General y Contenedores --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; transition: background-color 0.2s ease, color 0.2s ease; }
        #app-container-juanizador { max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        .page-header { background-color: var(--bg-secondary); padding: 15px 25px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .page-header h1 { margin: 0; font-size: 1.8em; font-weight: 500; }
        .header-controls { display: flex; align-items: center; gap: 20px; }
        .juanizador-section { background-color: var(--bg-secondary); border-radius: 8px; padding: 20px 25px; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .main-content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section-title { font-size: 1.5em; color: var(--text-primary); font-weight: 500; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-light-color); }
        
        /* --- Botones y Controles --- */
        .buttons-group { display: flex; gap: 12px; margin-bottom: 20px; }
        .btn { border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease; text-align: center; }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn-main { background-color: var(--accent-color); color: var(--accent-text-color); }
        .btn-main:hover { background-color: var(--btn-record-bg-hover); }
        .btn-danger { background-color: var(--btn-danger-bg); color: var(--accent-text-color); }
        .btn-danger:hover { background-color: var(--btn-danger-bg-hover); }
        .btn-success { background-color: var(--btn-success-bg); color: var(--accent-text-color); }
        .btn-success:hover { background-color: var(--btn-success-bg-hover); }
        #backToDictationBtn { flex: 0 1 auto; padding: 8px 15px; font-size: 0.9em; }
        #microphone-btn { background-color: var(--accent-color); color: var(--accent-text-color); border-radius: 50px; padding: 10px 20px; font-size: 1em; display: inline-flex; align-items: center; gap: 10px; }
        #microphone-btn.recording { background-color: var(--juanizador-accent-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0.5); } 70% { box-shadow: 0 0 0 10px rgba(var(--accent-color-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0); } }
        
        /* --- Inputs y Textareas --- */
        textarea, select { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--input-text); font-size: 1em; box-sizing: border-box; }
        textarea:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3); }
        #transcript { min-height: 150px; resize: vertical; margin-bottom: 20px; }

        /* --- Selectores de Técnica --- */
        .technique-selector-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .selector-group { display: flex; flex-direction: column; gap: 8px; }
        .selector-group label { font-weight: 500; color: var(--text-secondary); font-size: 0.9em; }
        .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .checkbox-group label { display: flex; align-items: center; gap: 8px; font-weight: normal; color: var(--text-primary); cursor: pointer; }
        .checkbox-group input[type="checkbox"] { margin-right: 5px; accent-color: var(--accent-color); }

        /* --- Contenido Categorizado y Final --- */
        .category { background-color: var(--bg-primary); border-left: 4px solid var(--accent-color); padding: 15px; margin-bottom: 10px; border-radius: 0 5px 5px 0; }
        .category h3 { margin-top: 0; margin-bottom: 8px; color: var(--text-primary); font-weight: 500; font-size: 1.1em; }
        .category ul { padding-left: 20px; margin: 5px 0 0 0; color: var(--text-secondary); }
        .finding-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 5px 0; }
        .finding-text { flex: 1; }
        .category-reassign { padding: 5px 8px; font-size: 0.85em; min-width: 150px; }
        #final-report { white-space: pre-wrap; background-color: var(--bg-primary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-light-color); min-height: 100px; color: var(--text-primary); }
        .technique-description { margin-bottom: 20px; background-color: var(--bg-primary); padding: 15px; border-radius: 4px; border-left: 4px solid var(--accent-color); }
        .technique-description h3 { margin-top: 0; margin-bottom: 10px; font-weight: 500; }
        
        /* --- Indicadores de Carga --- */
        .loading { text-align: center; margin: 20px 0; display: none; }
        .spinner { border: 4px solid var(--border-light-color); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--accent-color); animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-message { font-style: italic; color: var(--text-secondary); }

        /* --- Theme Switch --- */
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: center; }
        .theme-switch { display: inline-block; height: 22px; position: relative; width: 42px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--switch-bg); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 22px; }
        .slider:before { background-color: var(--switch-thumb-bg); bottom: 2px; content: ""; height: 18px; left: 2px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--switch-checked-bg); }
        input:checked + .slider:before { transform: translateX(20px); }
        .theme-switch-label { margin-left: 8px; font-size: 0.9em; color: var(--text-secondary); }

        /* --- Responsive --- */
        @media (max-width: 992px) { .main-content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .page-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .header-controls { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body data-theme="light">
    <div id="app-container-juanizador">
        <header class="page-header">
            <h1>Asistente de Informes Radiológicos</h1>
            <div class="header-controls">
                <button id="backToDictationBtn" class="btn btn-danger">Volver a dictado</button>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="themeToggleCheckboxJuanizador">
                        <input type="checkbox" id="themeToggleCheckboxJuanizador">
                        <span class="slider"></span>
                    </label>
                    <span id="themeToggleLabelJuanizador" class="theme-switch-label">Tema Oscuro</span>
                </div>
            </div>
        </header>
        
        <div class="juanizador-section technique-selector">
            <div class="technique-selector-grid">
                <div class="selector-group">
                    <label for="imaging-technique">Técnica de Imagen</label>
                    <select id="imaging-technique">
                        <option value="tac">TAC</option>
                        <option value="rm">RM</option>
                        <option value="eco">Ecografía</option>
                    </select>
                </div>
                
                <div class="selector-group" id="tac-scope-container">
                    <label for="tac-scope">Alcance del TAC</label>
                    <select id="tac-scope">
                        <option value="toracoabdominal">Toracoabdominal</option>
                        <option value="torax">Torácico</option>
                        <option value="abdomen">Abdominal</option>
                    </select>
                </div>
                
                <div class="selector-group" id="rm-type-container" style="display: none;">
                    <label for="rm-type">Tipo de RM</label>
                    <select id="rm-type">
                        <option value="hepatica">RM Hepática</option>
                        <option value="colangio">ColangioRM</option>
                        <option value="pelvis-neo">RM Pelvis NEO</option>
                        <option value="pelvis-fist">RM Pelvis FIST</option>
                        <option value="entero">EnteroRM</option>
                    </select>
                </div>
                
                <div class="selector-group" id="contrast-container">
                    <label for="contrast-use">Contraste</label>
                    <select id="contrast-use">
                        <option value="sin">Sin contraste</option>
                        <option value="con">Con contraste</option>
                    </select>
                </div>
                
                <div class="selector-group" id="phase-container" style="display: none;">
                    <label>Fase</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="phase" value="arterial"> Arterial</label>
                        <label><input type="checkbox" name="phase" value="portal"> Portal</label>
                        <label><input type="checkbox" name="phase" value="tardia"> Tardía</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content-grid">
            <div class="juanizador-section input-section">
                <h2 class="section-title">Entrada de Hallazgos</h2>
                
                <div class="voice-input" style="text-align: center; margin-bottom: 20px;">
                    <button id="microphone-btn" class="btn">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                        <span id="mic-text">Iniciar Dictado</span>
                    </button>
                </div>
                
                <textarea id="transcript" placeholder="Los hallazgos dictados o pegados desde la página anterior aparecerán aquí..."></textarea>
                
                <div class="buttons-group">
                    <button id="categorize-btn" class="btn btn-main">Categorizar Hallazgos</button>
                    <button id="clear-btn" class="btn btn-danger">Limpiar</button>
                </div>
                
                <div class="loading" id="categorizing-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Categorizando hallazgos...</p>
                </div>
                
                <div id="categorized-content"></div>
            </div>
            
            <div class="juanizador-section output-section">
                <h2 class="section-title">Informe Final</h2>
                
                <div class="buttons-group">
                    <button id="generate-report-btn" class="btn btn-success">Generar Informe</button>
                    <button id="copy-report-btn" class="btn btn-main">Copiar Informe</button>
                </div>
                
                <div class="loading" id="report-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Generando informe completo...</p>
                </div>
                
                <div class="technique-description" id="technique-description" style="display:none;">
                    <h3>Técnica</h3>
                    <p id="technique-text"></p>
                </div>
                
                <div id="final-report">El informe generado aparecerá aquí...</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- Theme Management ---
        const themeToggle = document.getElementById('themeToggleCheckboxJuanizador');
        const themeLabel = document.getElementById('themeToggleLabelJuanizador');

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            if (themeToggle) themeToggle.checked = theme === 'dark';
            if (themeLabel) themeLabel.textContent = theme === 'dark' ? 'Tema Claro' : 'Tema Oscuro';
        }

        function toggleTheme() {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('themePreferenceJuanizador', newTheme);
            localStorage.setItem('sharedThemePreference', newTheme);
        }

        if (themeToggle) themeToggle.addEventListener('change', toggleTheme);
        
        // --- Configuration Constants ---
        const API_KEY = 'AIzaSyBsKWbE6KgNaolK9BxDNDdviNw3pM7sOv0'; // WARNING: Exposed API Key
        const MODEL_NAME = 'gemini-1.5-flash';
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: MODEL_NAME });

        const anatomicalCategories = [ { id: 0, name: "Tiroides/glándula tiroidea" }, { id: 1, name: "Estructuras mediastínicas vasculares y/o corazón" }, { id: 2, name: "Adenopatías mediastínicas" }, { id: 3, name: "Parénquima pulmonar" }, { id: 4, name: "Derrame pleural y cambios secundarios" }, { id: 5, name: "Hígado, porta y confluente esplenomesentérico venoso" }, { id: 6, name: "Vesícula y vía biliar" }, { id: 7, name: "Páncreas" }, { id: 8, name: "Bazo, glándulas suprarrenales, riñones, vías excretoras, uréteres y vejiga urinaria" }, { id: 9, name: "Cámara gástrica, asas intestinales" }, { id: 10, name: "Líquido libre o adenopatías intra-abdominales" }, { id: 11, name: "Aorta y grandes vasos mesentéricos" }, { id: 12, name: "Esqueleto axial" }, { id: 13, name: "Otros hallazgos" } ];
        const categoryPrompts = { 0: "Describe SOLO los hallazgos mencionados en la glándula tiroidea. Si no hay hallazgos, devuelve EXACTAMENTE: 'Glándula tiroidea de tamaño y morfología normales, sin nódulos ni otras alteraciones radiológicas significativas.'", 1: "Describe SOLO los hallazgos en estructuras mediastínicas vasculares y/o corazón. Si no hay hallazgos, devuelve EXACTAMENTE: 'Estructuras mediastinicas vasculares sin hallazgos morfológicos de interés.'", 2: "Describe SOLO los hallazgos en adenopatías mediastínicas. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se identifican adenopatías mediastínicas de tamaño significativo.'", 3: "Describe SOLO los hallazgos en el parénquima pulmonar. Si no hay hallazgos, devuelve EXACTAMENTE: 'En el parénquima pulmonar no existen imágenes nodulares ni aumentos de densidad sugestivos de afectación patológica.'", 4: "Describe SOLO los hallazgos sobre derrame pleural. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se objetiva derrame pleural.'", 5: "Sigue este esquema para hígado, porta y confluente venoso: 1. Rasgos de hepatopatía crónica (si los hay, usa 'el hígado es de contornos lobulados y parénquima discretamente heterogéneo'; si no, usa 'el hígado es de bordes lisos y densidad homogénea'). 2. Describe lesiones ocupantes de espacio de forma concisa. 3. Describe hallazgos en porta, vena esplénica y mesentérica. Si no hay hallazgos, devuelve EXACTAMENTE: 'El hígado es de bordes lisos y densidad homogénea no identificándose lesiones ocupantes de espacio. Vena porta, esplénica y mesentérica de calibre normal, permeables.'", 6: "Describe SOLO los hallazgos en vesícula y vía biliar. Si no hay hallazgos, devuelve EXACTAMENTE: 'Vesícula biliar normodistendida, de paredes finas, sin evidencia de litiasis en su interior. Vía biliar intra y extrahepática no dilatada.'", 7: "Describe SOLO los hallazgos en el páncreas. Si no hay hallazgos, devuelve EXACTAMENTE: 'Páncreas homogéneo y bien definido sin lesiones focales ni dilatación del ducto pancreático principal.'", 8: "Describe SOLO los hallazgos en bazo, suprarrenales, riñones, vías excretoras y vejiga. Si no hay hallazgos, devuelve EXACTAMENTE: 'Bazo, glándulas suprarrenales y riñones de tamaño, morfología y densidad normales, sin evidencia de lesiones focales. Vías excretoras, uréteres y vejiga urinaria sin alteraciones radiológicas significativas.'", 9: "Describe SOLO los hallazgos en cámara gástrica y asas intestinales. Si no hay hallazgos, devuelve EXACTAMENTE: 'Cámara gástrica moderadamente distendida sin hallazgos relevantes. Asas intestinales de delgado y marco cólico sin engrosamientos parietales ni cambios de calibre significativos.'", 10: "Describe SOLO líquido libre o adenopatías intra-abdominales. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se observa líquido libre ni adenopatías intra-abdominales de aspecto patológico.'", 11: "Describe SOLO hallazgos en aorta y grandes vasos mesentéricos. Si no hay hallazgos, devuelve EXACTAMENTE: 'Aorta y grandes vasos mesentéricos de calibre normal, sin hallazgos significativos.'", 12: "Describe SOLO hallazgos en el esqueleto axial. Si no hay hallazgos, devuelve EXACTAMENTE: 'Esqueleto axial incluido en el estudio sin lesiones focales ni anomalías morfológicas relevantes.'", 13: "Describe SOLO hallazgos que no correspondan a otras categorías. Si no hay hallazgos, devuelve EXACTAMENTE: 'No hay otros hallazgos relevantes que reportar.'" };

        // --- State Variables ---
        let recognition, isRecording = false, categorizedFindings = {};
        const transcriptArea = document.getElementById('transcript');
        const thoracicCats = [0, 1, 2, 3, 4], abdominalCats = [5, 6, 7, 8, 9, 10, 11, 12], otherCats = [13];
        window.availableCategories = [];

        // --- Speech Recognition ---
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('microphone-btn').disabled = true;
                document.getElementById('mic-text').textContent = "No Soportado";
                return;
            }
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'es-ES';
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                }
                const start = transcriptArea.selectionStart;
                const end = transcriptArea.selectionEnd;
                transcriptArea.value = transcriptArea.value.substring(0, start) + finalTranscript.trim() + ' ' + transcriptArea.value.substring(end);
                transcriptArea.selectionStart = transcriptArea.selectionEnd = start + finalTranscript.length;
            };

            recognition.onend = () => { if (isRecording) recognition.start(); }; // Keep listening if active
            recognition.onerror = (event) => { console.error('Error de reconocimiento de voz:', event.error); isRecording = false; updateMicButton(); };
        }

        function toggleRecording() {
            if (!recognition) return;
            isRecording = !isRecording;
            if (isRecording) recognition.start();
            else recognition.stop();
            updateMicButton();
        }

        function updateMicButton() {
            const micBtn = document.getElementById('microphone-btn');
            const micText = document.getElementById('mic-text');
            micBtn.classList.toggle('recording', isRecording);
            micText.textContent = isRecording ? 'Detener Dictado' : 'Iniciar Dictado';
        }

        // --- API & Logic ---
        async function queryGeminiAPI(prompt) {
            try {
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) {
                console.error('Error al consultar la API:', error);
                alert("Error de comunicación con la API. Revisa la consola.");
                return null;
            }
        }

        async function categorizeFindings() {
            const transcript = transcriptArea.value.trim();
            if (!transcript) {
                alert('Por favor, dicte o escriba algún hallazgo primero.');
                return;
            }
            
            setLoadingState('categorizing-loading', true);
            const availableCats = window.availableCategories.includes(13) ? window.availableCategories : [...window.availableCategories, 13];
            const filteredCategories = anatomicalCategories.filter(cat => availableCats.includes(cat.id));
            const categoryNames = filteredCategories.map(cat => `${cat.id}. ${cat.name}`).join('\n');
            const learningDict = JSON.parse(localStorage.getItem('findingsLearningDictionary')) || {};

            const prompt = `Eres un radiólogo experto. Categoriza los siguientes hallazgos en las categorías disponibles.
            Categorías Disponibles:\n${categoryNames}
            Hallazgos a Categorizar:\n"${transcript}"
            ${Object.keys(learningDict).length > 0 ? `Usa estos ejemplos de categorizaciones previas como guía:\n${Object.entries(learningDict).map(([f, c]) => `"${f}" => Categoría ${c}`).join('\n')}` : ''}
            Devuelve un objeto JSON con claves de ID de categoría y valores como array de hallazgos. Incluye solo categorías con hallazgos. Devuelve SOLO el objeto JSON.`;
            
            try {
                const response = await queryGeminiAPI(prompt);
                if (!response) throw new Error('No se recibió respuesta de la API.');
                
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Respuesta no contiene un JSON válido.');

                categorizedFindings = JSON.parse(jsonMatch[0]);
                displayCategorizedFindings();
            } catch (error) {
                console.error('Error al categorizar:', error);
                alert('Hubo un error al categorizar los hallazgos. Inténtelo de nuevo.');
            } finally {
                setLoadingState('categorizing-loading', false);
            }
        }

        async function generateCompleteReport() {
            if (Object.keys(categorizedFindings).length === 0) {
                alert('Primero debe categorizar los hallazgos.');
                return;
            }
            setLoadingState('report-loading', true);
            document.getElementById('final-report').textContent = 'Generando informe...';
            
            let fullReport = '';
            for (const category of anatomicalCategories.filter(c => window.availableCategories.includes(c.id))) {
                const findings = categorizedFindings[category.id.toString()] || [];
                const prompt = `${categoryPrompts[category.id]}\nHallazgos encontrados: ${findings.length > 0 ? findings.join('. ') : 'Ninguno'}\nRedacta un párrafo conciso y profesional, sin mencionar la técnica de imagen.`;
                const sectionReport = await queryGeminiAPI(prompt);
                if (sectionReport) fullReport += `${sectionReport.trim()}\n`;
            }
            
            const allFindings = Object.values(categorizedFindings).flat();
            const conclusionPrompt = `Basado en estos hallazgos:\n${allFindings.join('. ')}\nGenera una conclusión concisa (máx. 2-3 líneas) con los 2-3 hallazgos más relevantes. Para el resto, usa "Ver informe descriptivo". No menciones la técnica. Si no hay hallazgos, devuelve: "No se observan alteraciones radiológicas significativas."`;
            const conclusion = await queryGeminiAPI(conclusionPrompt);
            if (conclusion) fullReport += `\n${conclusion.trim()}`;
            
            document.getElementById('final-report').textContent = fullReport;
            setLoadingState('report-loading', false);
        }

        function teachFindingCategorization(finding, categoryId) {
            let learningDict = JSON.parse(localStorage.getItem('findingsLearningDictionary')) || {};
            learningDict[finding] = categoryId;
            localStorage.setItem('findingsLearningDictionary', JSON.stringify(learningDict));
            alert(`Aprendido: "${finding}" se asignará a "${anatomicalCategories.find(c => c.id == categoryId).name}".`);
        }

        // --- UI Functions ---
        function setLoadingState(elementId, isLoading) { document.getElementById(elementId).style.display = isLoading ? 'block' : 'none'; }
        function displayCategorizedFindings() {
            const container = document.getElementById('categorized-content');
            container.innerHTML = '';
            if (Object.keys(categorizedFindings).length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">No hay hallazgos categorizados.</p>';
                return;
            }
            for (const catId in categorizedFindings) {
                const category = anatomicalCategories.find(c => c.id == catId);
                if (category && categorizedFindings[catId].length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';
                    const findingsList = categorizedFindings[catId].map(finding => {
                        if (parseInt(catId) === 13) {
                            return `<li class="finding-item"><span class="finding-text">${finding}</span><select class="category-reassign" data-finding="${finding}"><option value="">Reasignar a...</option>${anatomicalCategories.filter(c=>c.id!==13).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></li>`;
                        }
                        return `<li>${finding}</li>`;
                    }).join('');
                    categoryDiv.innerHTML = `<h3>${category.name}</h3><ul>${findingsList}</ul>`;
                    container.appendChild(categoryDiv);
                }
            }
            container.querySelectorAll('.category-reassign').forEach(select => select.addEventListener('change', handleReassign));
        }

        function handleReassign(e) {
            const finding = e.target.dataset.finding;
            const newCatId = e.target.value;
            if (newCatId) {
                teachFindingCategorization(finding, newCatId);
                categorizedFindings[newCatId] = [...(categorizedFindings[newCatId] || []), finding];
                categorizedFindings[13] = categorizedFindings[13].filter(f => f !== finding);
                if (categorizedFindings[13].length === 0) delete categorizedFindings[13];
                displayCategorizedFindings();
            }
        }

        function updateAvailableCategories() {
            const tech = document.getElementById('imaging-technique').value;
            const scope = document.getElementById('tac-scope').value;
            const rmContainer = document.getElementById('rm-type-container');
            const tacContainer = document.getElementById('tac-scope-container');
            const contrastContainer = document.getElementById('contrast-container');
            
            tacContainer.style.display = tech === 'tac' ? 'flex' : 'none';
            rmContainer.style.display = tech === 'rm' ? 'flex' : 'none';
            contrastContainer.style.display = tech === 'tac' || tech === 'rm' ? 'flex' : 'none';
            
            if (tech === 'tac') {
                if (scope === 'toracoabdominal') window.availableCategories = [...thoracicCats, ...abdominalCats, ...otherCats];
                else if (scope === 'torax') window.availableCategories = [...thoracicCats, ...otherCats];
                else window.availableCategories = [...abdominalCats, ...otherCats];
            } else { // RM and Eco default to abdominal
                window.availableCategories = [...abdominalCats, ...otherCats];
            }
            
            categorizedFindings = {};
            document.getElementById('categorized-content').innerHTML = '';
            updateTechniqueDescription();
        }

        function updateContrastOptions() {
            const tech = document.getElementById('imaging-technique').value;
            const contrast = document.getElementById('contrast-use').value;
            const phaseContainer = document.getElementById('phase-container');
            phaseContainer.style.display = (tech === 'tac' && contrast === 'con') ? 'flex' : 'none';
            if (phaseContainer.style.display === 'none') {
                document.querySelectorAll('input[name="phase"]').forEach(cb => cb.checked = false);
            }
            updateTechniqueDescription();
        }

        function updateTechniqueDescription() {
            const techSelect = document.getElementById('imaging-technique');
            const techniqueTextEl = document.getElementById('technique-text');
            const techniqueDescContainer = document.getElementById('technique-description');
            
            if (techSelect.value === 'eco') {
                techniqueDescContainer.style.display = 'none';
                return;
            }
            techniqueDescContainer.style.display = 'block';

            let description = "";
            if (techSelect.value === 'tac') {
                const scope = document.getElementById('tac-scope').options[document.getElementById('tac-scope').selectedIndex].text;
                const contrast = document.getElementById('contrast-use').value === 'con';
                description = `Se realiza exploración ${scope} ${contrast ? 'tras la' : 'sin'} administración endovenosa de contraste`;
                if (contrast) {
                    const phases = Array.from(document.querySelectorAll('input[name="phase"]:checked')).map(cb => cb.value);
                    if (phases.length > 0) description += ` con adquisición de imágenes en fase ${phases.join(' y ')}`;
                }
            } else { // RM
                const rmType = document.getElementById('rm-type').value;
                const contrast = document.getElementById('contrast-use').value === 'con';
                const contrastText = contrast ? ' y estudio dinámico tras la administración endovenosa de contraste' : '';
                const rmPrompts = {
                    hepatica: `Se realiza exploración abdominal con secuencias potenciadas en T1 en fase y fuera de fase, T2 sin y con saturación grasa, difusión${contrastText}.`,
                    colangio: `Se realiza exploración abdominal con secuencias potenciadas en T1, T2 y colangiopancreatografía por RM (CPRM).`,
                    'pelvis-neo': `Se realiza exploración pélvica con secuencias T2 en los tres planos, difusión${contrastText}.`,
                    'pelvis-fist': `Se realiza exploración pélvica con secuencias T2 sin y con saturación grasa y secuencias T1 tras contraste.`,
                    entero: `Se realiza exploración de asas de intestino delgado con secuencias T2 y difusión ${contrastText} previa distensión de asas.`
                };
                description = rmPrompts[rmType] || "Descripción de RM no definida.";
            }
            techniqueTextEl.textContent = description.trim() + '.';
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Theme setup
            const sharedTheme = localStorage.getItem('sharedThemePreference');
            const localTheme = localStorage.getItem('themePreferenceJuanizador');
            applyTheme(sharedTheme || localTheme || 'light');
            
            // Data from main page
            const inputTextFromIndex = localStorage.getItem('juanizadorInputText');
            if (inputTextFromIndex) {
                transcriptArea.value = inputTextFromIndex;
                localStorage.removeItem('juanizadorInputText'); 
            }

            // Event Listeners
            document.getElementById('backToDictationBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            document.getElementById('microphone-btn').addEventListener('click', toggleRecording);
            document.getElementById('categorize-btn').addEventListener('click', categorizeFindings);
            document.getElementById('clear-btn').addEventListener('click', () => {
                transcriptArea.value = '';
                categorizedFindings = {};
                document.getElementById('categorized-content').innerHTML = '';
                document.getElementById('final-report').textContent = 'El informe generado aparecerá aquí...';
            });
            document.getElementById('generate-report-btn').addEventListener('click', generateCompleteReport);
            document.getElementById('copy-report-btn').addEventListener('click', () => {
                const techniqueContainer = document.getElementById('technique-description');
                const techniqueText = techniqueContainer.style.display !== 'none' ? document.getElementById('technique-text').textContent : '';
                const reportText = document.getElementById('final-report').textContent;
                const fullText = (techniqueText ? techniqueText + "\n\n" : "") + reportText;
                navigator.clipboard.writeText(fullText).then(() => alert('Informe completo copiado al portapapeles.'), () => alert('Error al copiar.'));
            });

            ['imaging-technique', 'tac-scope'].forEach(id => document.getElementById(id).addEventListener('change', updateAvailableCategories));
            ['rm-type', 'contrast-use'].forEach(id => document.getElementById(id).addEventListener('change', updateContrastOptions));
            document.querySelectorAll('input[name="phase"]').forEach(cb => cb.addEventListener('change', updateTechniqueDescription));
            
            // Initial state
            initSpeechRecognition();
            updateAvailableCategories();
        });
    </script>
</body>
</html>
