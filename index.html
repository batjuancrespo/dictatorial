<html><head><base href="/" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente de transcripción radiológico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Playfair+Display:wght@400,700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-color: #f8f8f8;
    --text-color: #333;
    --primary-color: #2c3e50;
    --secondary-color: #34495e;
    --container-bg: #ffffff;
    --border-color: #e0e0e0;
    --listening-bg-color: #e8f5e9;
  }

  body.dark-mode {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --primary-color: #3498db;
    --secondary-color: #2980b9;
    --container-bg: #2c2c2c;
    --border-color: #444;
    --listening-bg-color: #1b5e20;
  }

  body {
    font-family: 'Roboto', sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background-color: var(--bg-color);
    color: var(--text-color);
    transition: all 0.3s ease;
  }

  .container {
    text-align: center;
    padding: 3rem;
    background-color: var(--container-bg);
    border-radius: 15px;
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 1200px;
    height: 90vh;
    display: flex;
    flex-direction: column;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 2rem;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 0.5rem;
  }

  #output {
    margin-top: 1.5rem;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    flex-grow: 1;
    overflow-y: auto;
    text-align: left;
    white-space: pre-wrap;
    word-wrap: break-word;
    background-color: var(--container-bg);
    color: var(--text-color);
    font-size: 1.1rem;
    line-height: 1.6;
  }

  #output.listening {
    background-color: var(--listening-bg-color);
    transition: background-color 0.3s ease;
  }

  .button-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  button {
    background-color: transparent;
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    padding: 12px 24px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
    font-family: 'Roboto', sans-serif;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  button:hover {
    background-color: var(--primary-color);
    color: var(--container-bg);
  }

  #correctButton {
    border-color: var(--secondary-color);
    color: var(--secondary-color);
  }

  #correctButton:hover {
    background-color: var(--secondary-color);
    color: var(--container-bg);
  }

  #copyButton {
    border-color: #27ae60;
    color: #27ae60;
  }

  #copyButton:hover {
    background-color: #27ae60;
    color: var(--container-bg);
  }

  .theme-switch-wrapper {
    display: flex;
    align-items: center;
    position: absolute;
    top: 20px;
    right: 20px;
  }

  .theme-switch-wrapper i {
    margin: 0 5px;
    font-size: 1.2rem;
    color: var(--text-color);
    transition: opacity 0.3s ease;
  }

  .theme-switch-wrapper i.fa-sun {
    opacity: 1;
  }

  .theme-switch-wrapper i.fa-moon {
    opacity: 0.5;
  }

  body.dark-mode .theme-switch-wrapper i.fa-sun {
    opacity: 0.5;
  }

  body.dark-mode .theme-switch-wrapper i.fa-moon {
    opacity: 1;
  }

  .theme-switch {
    display: inline-block;
    height: 34px;
    position: relative;
    width: 60px;
  }

  .theme-switch input {
    display: none;
  }

  .slider {
    background-color: #ccc;
    bottom: 0;
    cursor: pointer;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    transition: .4s;
  }

  .slider:before {
    background-color: #fff;
    bottom: 4px;
    content: "";
    height: 26px;
    left: 4px;
    position: absolute;
    transition: .4s;
    width: 26px;
  }

  input:checked + .slider {
    background-color: var(--primary-color);
  }

  input:checked + .slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }
</style>
</head>
<body>
  <div class="theme-switch-wrapper">
    <i class="fas fa-sun"></i>
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    <i class="fas fa-moon"></i>
  </div>
  <div class="container">
    <h1>Asistente de transcripción radiológico</h1>
    <div class="button-container">
      <button id="startButton">Iniciar Reconocimiento</button>
      <button id="correctButton">Corregir Dictado</button>
      <button id="copyButton">Copiar al Portapapeles</button>
    </div>
    <div id="output" contenteditable="true"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
  <script>
    const startButton = document.getElementById('startButton');
    const correctButton = document.getElementById('correctButton');
    const copyButton = document.getElementById('copyButton');
    const output = document.getElementById('output');
    const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');

    function switchTheme(e) {
      if (e.target.checked) {
        document.body.classList.add('dark-mode');
        document.querySelector('.fa-sun').style.opacity = '0.5';
        document.querySelector('.fa-moon').style.opacity = '1';
      } else {
        document.body.classList.remove('dark-mode');
        document.querySelector('.fa-sun').style.opacity = '1';
        document.querySelector('.fa-moon').style.opacity = '0.5';
      }    
    }

    toggleSwitch.addEventListener('change', switchTheme, false);

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function capitalizeAfterPeriod(text) {
      return text.replace(/\.\s*([a-zá-úñ])/gi, match => match.toUpperCase());
    }

    function processPunctuation(text) {
      return text.replace(/\s+punto\s+y\s+aparte\s+/gi, '.\n')
                 .replace(/\s+punto\s+/gi, '. ')
                 .replace(/\s+coma\s+/gi, ', ')
                 .replace(/\s+punto$/gi, '.')
                 .replace(/\s+coma$/gi, ',')
                 .replace(/\s+punto\s+y\s+aparte$/gi, '.\n');
    }

    function processText(text) {
      let processed = processPunctuation(text);
      processed = capitalizeFirstLetter(processed);
      processed = capitalizeAfterPeriod(processed);
      return processed;
    }

    function removeExtraSpaces(text) {
      return text.replace(/[^\S\n]+/g, ' ').replace(/\s*\n\s*/g, '\n').trim();
    }

    function integrateNewText(originalText, newText, start, end) {
      // If there's no selection (start === end), append the new text
      if (start === end && start === originalText.length) {
        return removeExtraSpaces(originalText + (originalText ? ' ' : '') + newText);
      }

      let beforeSelection = originalText.substring(0, start);
      let afterSelection = originalText.substring(end);

      newText = newText.trim();

      // Preserve line breaks at the beginning and end of the new text
      let leadingNewline = newText.startsWith('\n') ? '\n' : '';
      let trailingNewline = newText.endsWith('\n') ? '\n' : '';
      newText = newText.replace(/^\n+|\n+$/g, '');

      // Handle space before new text
      let spaceBeforeNew = ' ';
      if (beforeSelection.match(/[\n.!?:;,]$/) || beforeSelection.length === 0) {
        spaceBeforeNew = '';
      }

      // Capitalize first letter after a period
      if (beforeSelection.trim().endsWith('.')) {
        newText = capitalizeFirstLetter(newText);
      }

      // Handle space after new text
      let spaceAfterNew = afterSelection.match(/^\S/) && !trailingNewline ? ' ' : '';

      // Combine the text parts
      let combinedText = beforeSelection + leadingNewline + spaceBeforeNew + newText + trailingNewline + spaceAfterNew + afterSelection;

      // Ensure no double spaces are created
      combinedText = combinedText.replace(/  +/g, ' ');

      // Preserve existing line breaks
      combinedText = combinedText.replace(/\n +/g, '\n').replace(/ +\n/g, '\n');

      return removeExtraSpaces(combinedText);
    }

    let isListening = false;
    let transcript = '';
    let isReplacing = false;
    let replacementStart = 0;
    let replacementEnd = 0;
    let learningDictionary = {};

    if (annyang) {
      annyang.setLanguage('es-ES');

      annyang.addCallback('result', function(phrases) {
        if (phrases.length > 0) {
          let recognizedText = phrases[0];
          
          for (let key in learningDictionary) {
            recognizedText = recognizedText.replace(new RegExp(key, 'gi'), learningDictionary[key]);
          }

          if (isReplacing) {
            transcript = integrateNewText(output.textContent, recognizedText, replacementStart, replacementEnd);
          } else {
            // Add a space before the new text if it doesn't start with punctuation
            if (transcript && !recognizedText.match(/^[.!?:;,]/)) {
              transcript += ' ';
            }
            transcript += recognizedText;
            transcript = removeExtraSpaces(transcript);
          }
          const processedText = processText(transcript);
          output.textContent = processedText;
          output.scrollTop = output.scrollHeight;

          isReplacing = false;
          replacementStart = 0;
          replacementEnd = 0;
        }
      });

      // Handle interim results
      annyang.addCallback('soundstart', function() {
        if (output.textContent === 'Escuchando...') {
          output.textContent = '';
        }
      });

      function startListening() {
        annyang.start({ autoRestart: true, continuous: true });
        startButton.textContent = 'Detener Reconocimiento';
        output.classList.add('listening');
        
        // Preserve existing text when restarting recognition
        if (output.textContent && output.textContent !== 'Escuchando...') {
          transcript = output.textContent;
        } else {
          output.textContent = 'Escuchando...';
        }
        
        isListening = true;
      }

      function stopListening() {
        annyang.abort();
        startButton.textContent = 'Iniciar Reconocimiento';
        output.classList.remove('listening');
        isListening = false;
      }

      startButton.addEventListener('click', function() {
        if (!isListening) {
          let selection = window.getSelection();
          if (selection.rangeCount > 0) {
            let range = selection.getRangeAt(0);
            if (range.startContainer === output || output.contains(range.startContainer)) {
              isReplacing = true;
              replacementStart = range.startOffset;
              replacementEnd = range.endOffset;
            } else {
              // If no valid selection, set up to append text
              isReplacing = false;
              replacementStart = output.textContent.length;
              replacementEnd = output.textContent.length;
            }
          } else {
            // If no selection, set up to append text
            isReplacing = false;
            replacementStart = output.textContent.length;
            replacementEnd = output.textContent.length;
          }
          
          startListening();
        } else {
          stopListening();
        }
      });

      correctButton.addEventListener('click', function() {
        let selection = window.getSelection();
        if (selection.rangeCount > 0) {
          let range = selection.getRangeAt(0);
          if (range.startContainer === output || output.contains(range.startContainer)) {
            let selectedText = selection.toString();
            let correctedText = prompt(`¿Qué querías decir en lugar de "${selectedText}"?`);
            if (correctedText) {
              learningDictionary[selectedText.toLowerCase()] = correctedText;
              let newText = output.textContent.replace(selectedText, correctedText);
              output.textContent = newText;
              transcript = newText;
            }
          }
        } else {
          alert("Por favor, selecciona el texto que deseas corregir antes de hacer clic en 'Corregir Dictado'.");
        }
      });

      copyButton.addEventListener('click', function() {
        const textToCopy = output.textContent;
        navigator.clipboard.writeText(textToCopy).then(function() {
          alert('Texto copiado al portapapeles');
        }, function(err) {
          console.error('Error al copiar el texto: ', err);
          alert('No se pudo copiar el texto. Por favor, inténtalo de nuevo.');
        });
      });

      output.addEventListener('input', function() {
        transcript = output.textContent;
      });

      output.addEventListener('mouseup', function() {
        let selection = window.getSelection();
        if (selection.rangeCount > 0) {
          let range = selection.getRangeAt(0);
          if (range.startContainer === output || output.contains(range.startContainer)) {
            isReplacing = true;
            replacementStart = range.startOffset;
            replacementEnd = range.endOffset;
          }
        }
      });
    } else {
      startButton.style.display = 'none';
      correctButton.style.display = 'none';
      copyButton.style.display = 'none';
      output.textContent = 'Lo siento, tu navegador no soporta el reconocimiento de voz.';
    }
  </script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

<script>
  // Tu configuración de Firebase
  var firebaseConfig = {

    apiKey: "AIzaSyA_VQH1y-px8-QF3gMw3VOPjiiU1OefDBo",
    authDomain: "almacena-correcciones-dictado.firebaseapp.com",
    projectId: "almacena-correcciones-dictado",
    storageBucket: "almacena-correcciones-dictado.appspot.com",
    messagingSenderId: "209194920272",
    appId: "1:209194920272:web:ccbec69d0a5aa88789e455",
    measurementId: "G-6PQSKYMDP0"


  };
  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();


    // Cargar correcciones al iniciar la página
  window.onload = async function() {
    const querySnapshot = await db.collection("corrections").get();
    querySnapshot.forEach((doc) => {
      let correction = doc.data();
      learningDictionary[correction.original] = correction.corrected;
    });
    console.log("Correcciones cargadas:", learningDictionary);
  }
</script>

</body>
</html>
