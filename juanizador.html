<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Informes Radiol√≥gicos</title>
    <style>
        /* --- CSS Variables --- */
        :root {
            --bg-color: #f4f4f4; --container-bg: #fff; --text-color: #333; --text-muted-color: #555; --heading-color: #333; --border-color: #ccc; --border-light-color: #eee; --border-dashed-color: #ddd; --link-color: #007bff;
            --button-primary-bg: #007bff; --button-primary-hover-bg: #0056b3; --button-primary-text: white; --button-secondary-bg: #6c757d; --button-secondary-hover-bg: #5a6268; --button-secondary-text: white;
            --button-success-bg: #28a745; --button-success-hover-bg: #218838; --button-success-text: white; --button-danger-bg: #dc3545; --button-danger-hover-bg: #c82333; --button-danger-text: white; --button-warning-bg: #ffc107; --button-warning-hover-bg: #e0a800; --button-warning-text: #212529;
            --button-info-bg: #17a2b8; --button-info-hover-bg: #138496; --button-info-text: white; --button-light-gray-bg: #e9e9e9; --button-light-gray-hover-bg: #d8d8d8; --button-light-gray-text: #333;
            --button-violet-bg: #6f42c1; --button-violet-hover-bg: #5a349b; --button-violet-text: white;
            --button-suggestion-bg: #f8f8f8; --button-suggestion-hover-bg: #e8e8e8; --button-suggestion-border: #ccc; --button-disabled-bg: #cccccc; --button-disabled-opacity: 0.7;
            --input-bg: white; --input-border: #ccc; --input-text: #333; --header-area-bg: #f9f9f9; --header-area-border: #eee; --status-listening-color: #777; --status-base-color: #555;
            --slider-thumb-bg: #007bff; --slider-track-bg: #ddd; --switch-bg: #ccc; --switch-thumb-bg: white; --switch-checked-bg: #007bff;
            --juanizador-accent-color: var(--button-danger-bg);
            --juanizador-secondary-color: var(--button-primary-bg);
            --juanizador-primary-color: var(--heading-color);
            --juanizador-dark-color: #34495e;
        }

        body.dark-mode {
             --bg-color: #22272e; --container-bg: #2d333b; --text-color: #adbac7; --text-muted-color: #768390; --heading-color: #adbac7; --border-color: #444c56; --border-light-color: #373e47; --border-dashed-color: #444c56; --link-color: #539bf5;
             --button-primary-bg: #377ef0; --button-primary-hover-bg: #539bf5; --button-secondary-bg: #444c56; --button-secondary-hover-bg: #5d6774; --button-secondary-text: #adbac7;
             --button-success-bg: #347d39; --button-success-hover-bg: #46954a; --button-danger-bg: #e5534b; --button-danger-hover-bg: #f47067;
             --button-warning-bg: #d9971a; --button-warning-hover-bg: #f0b72f; --button-warning-text: #22272e; --button-info-bg: #4387d9; --button-info-hover-bg: #539bf5; --button-light-gray-bg: #373e47; --button-light-gray-hover-bg: #444c56; --button-light-gray-text: #adbac7;
             --button-violet-bg: #8a63d2; --button-violet-hover-bg: #9b7ae0;
             --button-suggestion-bg: #373e47; --button-suggestion-hover-bg: #444c56; --button-suggestion-border: #5d6774; --button-disabled-bg: #444c56; --input-bg: #22272e; --input-border: #444c56; --input-text: #adbac7;
             --header-area-bg: #22272e; --header-area-border: #373e47; --status-listening-color: #768390; --status-base-color: #768390;
             --slider-thumb-bg: #539bf5; --slider-track-bg: #444c56; --switch-bg: #444c56; --switch-thumb-bg: #768390; --switch-checked-bg: #377ef0;
            --juanizador-accent-color: var(--button-danger-bg);
            --juanizador-secondary-color: var(--button-primary-bg);
            --juanizador-primary-color: var(--heading-color);
            --juanizador-dark-color: #5d6774;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container-juanizador {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background-color: var(--container-bg);
            color: var(--heading-color);
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .page-header h1 {
            margin: 0;
            font-size: 1.8em;
            flex-grow: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .juanizador-section {
            background-color: var(--container-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border-light-color);
        }

        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section-title {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light-color);
            color: var(--juanizador-primary-color);
            font-size: 1.5em;
        }

        .voice-input {
            text-align: center;
            margin-bottom: 20px;
        }

        #microphone-btn {
            background-color: var(--juanizador-secondary-color);
            color: var(--button-primary-text);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #microphone-btn:hover {
            background-color: var(--juanizador-dark-color);
        }

        #microphone-btn svg {
            margin-right: 10px;
            height: 20px;
            width: 20px;
        }

        #microphone-btn.recording {
            background-color: var(--juanizador-accent-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        #transcript, .category-reassign, .selector-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 1em;
            box-sizing: border-box;
        }
        #transcript {
            min-height: 150px;
            resize: vertical;
            margin-bottom: 20px;
        }

        .categorized-content {
            margin-bottom: 20px;
        }

        .category {
            background-color: var(--header-area-bg);
            border-left: 4px solid var(--juanizador-secondary-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }

        .category h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--heading-color);
        }

        .category-content {
            margin-left: 10px;
            color: var(--text-muted-color);
        }
        .category-content ul {
            padding-left: 20px;
            margin-top: 5px;
        }


        #final-report {
            white-space: pre-wrap;
            background-color: var(--header-area-bg);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            min-height: 100px;
            color: var(--text-color);
        }

        .buttons-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            color: var(--button-primary-text);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            flex: 1;
            transition: background-color 0.3s ease;
            text-align: center;
            min-width: 100px;
        }
        .btn.btn-main { background-color: var(--button-primary-bg); }
        .btn.btn-main:hover { background-color: var(--button-primary-hover-bg); }

        .btn.btn-danger { background-color: var(--button-danger-bg); color: var(--button-danger-text); }
        .btn.btn-danger:hover { background-color: var(--button-danger-hover-bg); }

        .btn.btn-success { background-color: var(--button-success-bg); color: var(--button-success-text); }
        .btn.btn-success:hover { background-color: var(--button-success-hover-bg); }

        #backToDictationBtn {
            flex: 0 1 auto;
            padding: 8px 15px;
            font-size: 0.9em;
        }


        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--juanizador-secondary-color);
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            margin-top: 10px;
            font-style: italic;
            color: var(--text-muted-color);
        }

        .technique-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .selector-group {
            display: flex;
            flex-direction: column;
        }

        .selector-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--heading-color);
        }

        .technique-description {
            margin-bottom: 20px;
            background-color: var(--header-area-bg);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--juanizador-secondary-color);
        }

        .technique-description h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--heading-color);
        }

        .technique-description p {
            margin: 0;
            color: var(--text-color);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            color: var(--text-color);
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
            accent-color: var(--juanizador-secondary-color);
        }


        .finding-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .finding-text {
            flex: 1;
            margin-right: 10px;
        }

        .finding-controls {
            display: flex;
            gap: 5px;
        }

        .category-reassign {
            padding: 5px 8px;
            font-size: 0.85em;
            min-width: 150px;
        }

        .theme-switch-wrapper { display: flex; align-items: center; justify-content: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display: none; }
        .slider.round { background-color: var(--switch-bg); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider.round:before { background-color: var(--switch-thumb-bg); bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider.round { background-color: var(--switch-checked-bg); }
        input:checked + .slider.round:before { transform: translateX(24px); }
        .theme-switch-wrapper span { margin-left: 8px; font-size: 0.9em; color: var(--text-muted-color); }


        @media (max-width: 992px) {
            .main-content-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .page-header h1 {
                text-align: left;
                 margin-bottom: 10px;
            }
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            #backToDictationBtn {
                 margin-left: 0;
            }
            .technique-selector-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="light-mode">
    <div id="app-container-juanizador">
        <header class="page-header">
            <h1>Asistente de Informes Radiol√≥gicos</h1>
            <div class="header-controls">
                <button id="backToDictationBtn" class="btn btn-danger">Volver a dictado</button>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="themeToggleCheckboxJuanizador">
                        <input type="checkbox" id="themeToggleCheckboxJuanizador">
                        <span class="slider round"></span>
                    </label>
                    <span id="themeToggleLabelJuanizador">Tema Oscuro</span>
                </div>
            </div>
        </header>
        
        <div class="juanizador-section technique-selector">
            <div class="technique-selector-grid">
                <div class="selector-group">
                    <label for="imaging-technique">T√©cnica de Imagen:</label>
                    <select id="imaging-technique">
                        <option value="tac">TAC</option>
                        <option value="rm">RM</option>
                        <option value="eco">Ecograf√≠a</option>
                    </select>
                </div>
                
                <div class="selector-group" id="tac-scope-container">
                    <label for="tac-scope">Alcance del TAC:</label>
                    <select id="tac-scope">
                        <option value="toracoabdominal">Toracoabdominal</option>
                        <option value="torax">Tor√°cico</option>
                        <option value="abdomen">Abdominal</option>
                    </select>
                </div>
                
                <div class="selector-group" id="rm-type-container" style="display: none;">
                    <label for="rm-type">Tipo de RM:</label>
                    <select id="rm-type">
                        <option value="hepatica">RM Hep√°tica</option>
                        <option value="colangio">ColangioRM</option>
                        <option value="pelvis-neo">RM Pelvis NEO</option>
                        <option value="pelvis-fist">RM Pelvis FIST</option>
                        <option value="entero">EnteroRM</option>
                    </select>
                </div>
                
                <div class="selector-group" id="contrast-container">
                    <label for="contrast-use">Contraste:</label>
                    <select id="contrast-use">
                        <option value="sin">Sin contraste</option>
                        <option value="con">Con contraste</option>
                    </select>
                </div>
                
                <div class="selector-group" id="phase-container" style="display: none;">
                    <label for="contrast-phase">Fase:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="phase" value="arterial"> Arterial</label>
                        <label><input type="checkbox" name="phase" value="portal"> Portal</label>
                        <label><input type="checkbox" name="phase" value="tardia"> Tard√≠a</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content-grid">
            <div class="juanizador-section input-section">
                <h2 class="section-title">Entrada de Hallazgos</h2>
                
                <div class="voice-input">
                    <button id="microphone-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        Iniciar Dictado
                    </button>
                </div>
                
                <textarea id="transcript" placeholder="Los hallazgos dictados aparecer√°n aqu√≠..."></textarea>
                
                <div class="buttons-group">
                    <button id="categorize-btn" class="btn btn-main">Categorizar Hallazgos</button>
                    <button id="clear-btn" class="btn btn-danger">Limpiar</button>
                </div>
                
                <div class="loading" id="categorizing-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Categorizando hallazgos...</p>
                </div>
                
                <div class="categorized-content" id="categorized-content">
                    <!-- Categor√≠as generadas din√°micamente -->
                </div>
            </div>
            
            <div class="juanizador-section output-section">
                <h2 class="section-title">Informe Final</h2>
                
                <div class="buttons-group">
                    <button id="generate-report-btn" class="btn btn-success">Generar Informe</button>
                    <button id="copy-report-btn" class="btn btn-main">Copiar Informe</button>
                </div>
                
                <div class="loading" id="report-loading">
                    <div class="spinner"></div>
                    <p class="status-message">Generando informe completo...</p>
                </div>
                
                <div class="technique-description" id="technique-description" style="display:none;">
                    <h3>T√©cnica</h3>
                    <p id="technique-text"></p>
                </div>
                
                <div id="final-report">
                    El informe generado aparecer√° aqu√≠...
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- Theme Toggle Logic ---
        const themeToggleCheckboxJuanizador = document.getElementById('themeToggleCheckboxJuanizador');
        const themeToggleLabelJuanizador = document.getElementById('themeToggleLabelJuanizador');

        function applyThemeJuanizador(theme) { // 'theme' ser√° 'light' o 'dark'
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
            }
            if (themeToggleCheckboxJuanizador) themeToggleCheckboxJuanizador.checked = theme === 'dark';
            if (themeToggleLabelJuanizador) themeToggleLabelJuanizador.textContent = theme === 'dark' ? 'Tema Claro' : 'Tema Oscuro';
        }

        function toggleThemeJuanizador() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyThemeJuanizador(currentTheme);
            localStorage.setItem('themePreferenceJuanizador', currentTheme); // Guarda preferencia local de esta p√°gina
        }

        if (themeToggleCheckboxJuanizador) {
            themeToggleCheckboxJuanizador.addEventListener('change', toggleThemeJuanizador);
        }
        // --- End Theme Toggle ---

        /*********************
         * CONFIG CONSTANTS
         *********************/
        const API_KEY = 'AIzaSyBsKWbE6KgNaolK9BxDNDdviNw3pM7sOv0'; 
        const MODEL_NAME = 'gemini-1.5-flash';
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: MODEL_NAME });

        const anatomicalCategories = [
            { id: 0, name: "Tiroides/gl√°ndula tiroidea" }, { id: 1, name: "Estructuras mediast√≠nicas vasculares y/o coraz√≥n" }, { id: 2, name: "Adenopat√≠as mediast√≠nicas" }, { id: 3, name: "Par√©nquima pulmonar" }, { id: 4, name: "Derrame pleural y cambios secundarios" }, { id: 5, name: "H√≠gado, porta y confluente esplenomesent√©rico venoso" }, { id: 6, name: "Ves√≠cula y v√≠a biliar" }, { id: 7, name: "P√°ncreas" }, { id: 8, name: "Bazo, gl√°ndulas suprarrenales, ri√±ones, v√≠as excretoras, ur√©teres y vejiga urinaria" }, { id: 9, name: "C√°mara g√°strica, asas intestinales" }, { id: 10, name: "L√≠quido libre o adenopat√≠as intra-abdominales" }, { id: 11, name: "Aorta y grandes vasos mesent√©ricos" }, { id: 12, name: "Esqueleto axial" }, { id: 13, name: "Otros hallazgos" }
        ];

        const categoryPrompts = {
            0: "Describe SOLO los hallazgos mencionados en la gl√°ndula tiroidea, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Gl√°ndula tiroidea de tama√±o y morfolog√≠a normales, sin n√≥dulos ni otras alteraciones radiol√≥gicas significativas.'",
            1: "Describe SOLO los hallazgos mencionados en estructuras mediast√≠nicas vasculares y/o coraz√≥n, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Estructuras mediastinicas vasculares sin hallazgos morfol√≥gicos de inter√©s.'",
            2: "Describe SOLO los hallazgos mencionados en adenopat√≠as mediast√≠nicas, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se identifican adenopat√≠as mediast√≠nicas de tama√±o significativo.'",
            3: "Describe SOLO los hallazgos mencionados en el par√©nquima pulmonar, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'En el par√©nquima pulmonar no existen im√°genes nodulares ni aumentos de densidad sugestivos de afectaci√≥n patol√≥gica'",
            4: "Describe SOLO los hallazgos mencionados sobre derrame pleural, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se objetiva derrame pleural.'",
            5: " A la hora de describir los hallazgos en el h√≠gado, porta y confluente esplenomesent√©rico venoso me gusta seguir un esquema. En primer lugar hay que hablar si hay rasgos de hepatopat√≠a cr√≥nica o no. Si los hay me gusta la frase el h√≠gado es de contornos lobulados y par√©nquima discretamente heterog√©neo en relaci√≥n con rasgos de hepatopat√≠a cr√≥nica. Si no los hay me gusta la frase el h√≠gado es de bordes lisos y densidad homog√©nea. Una de estas 2 frases ha de estar incluida necesariamente en el informe. A partir de ah√≠ describe si existen lesiones ocupantes de espacio brevemente con las caracter√≠sticas radiol√≥gicas principales de forma concisa teniendo en cuenta si estamos dictando un TAC, una resonancia o una eco ( no m√°s de una frase de las caracter√≠sticas de cada tipo de lesi√≥n) con las caracteristicas que tambien se te aporten en los hallazgos. Describe tambi√©n cualquier hallazgo relativo a porta, vena espl√©nica, vena mesent√©rica y confluente esplenomesent√©rico venoso, sin a√±adir interpretaciones o elaboraciones. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. S√© conciso y espec√≠fico. Si no hay hallazgos, devuelve EXACTAMENTE: 'El h√≠gado es de bordes lisos y densidad homog√©nea no identific√°ndose lesiones ocupantes de espacio. Vena porta, espl√©nica y mesent√©rica de calibre normal, permeables.'",
            6: "Describe SOLO los hallazgos mencionados en ves√≠cula y v√≠a biliar, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Ves√≠cula biliar normodistendida, de paredes finas, sin evidencia de litiasis en su interior. V√≠a biliar intra y extrahep√°tica no dilatada.'",
            7: "Describe SOLO los hallazgos mencionados en el p√°ncreas, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'P√°ncreas homog√©neo y bien definido sin lesiones focales ni dilataci√≥n del ducto pancre√°tico principal.'",
            8: "Describe SOLO los hallazgos mencionados en bazo, gl√°ndulas suprarrenales, ri√±ones, v√≠as excretoras, ur√©teres y vejiga urinaria, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Bazo, gl√°ndulas suprarrenales y ri√±ones de tama√±o, morfolog√≠a y densidad normales, sin evidencia de lesiones focales. V√≠as excretoras, ur√©teres y vejiga urinaria sin alteraciones radiol√≥gicas significativas.'",
            9: "Describe SOLO los hallazgos mencionados en c√°mara g√°strica y asas intestinales, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'C√°mara g√°strica moderadamente distendida sin hallazgos relevantes. Asas intestinales de delgado y marco c√≥lico sin engrosamientos parietales ni cambios de calibre significativos.'",
            10: "Describe SOLO los hallazgos mencionados sobre l√≠quido libre o adenopat√≠as intra-abdominales, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'No se observa l√≠quido libre ni adenopat√≠as intra-abdominales de aspecto patol√≥gico.'",
            11: "Describe SOLO los hallazgos mencionados en aorta y grandes vasos mesent√©ricos, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Aorta y grandes vasos mesent√©ricos de calibre normal, sin hallazgos significativos.'",
            12: "Describe SOLO los hallazgos mencionados en el esqueleto axial, sin a√±adir interpretaciones o elaboraciones. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'Esqueleto axial incluido en el estudio sin lesiones focales ni anomal√≠as morfol√≥gicas relevantes.'",
            13: "Describe SOLO los hallazgos que no corresponden claramente a otras categor√≠as anat√≥micas. S√© conciso y espec√≠fico. NO menciones la t√©cnica de imagen utilizada (TAC, RM, etc.) en tu descripci√≥n. Si no hay hallazgos, devuelve EXACTAMENTE: 'No hay otros hallazgos relevantes que reportar.'"
        };

        let recognition, isRecording = false, transcriptArea; 

        function initSpeechRecognition() {
            // ... (funci√≥n id√©ntica) ...
        }
        function insertAtCaret(textArea, text) {
            // ... (funci√≥n id√©ntica) ...
        }
        function toggleRecording() {
            // ... (funci√≥n id√©ntica) ...
        }

        let categorizedFindings = {};
        async function queryGeminiAPI(prompt) {
            // ... (funci√≥n id√©ntica) ...
        }
        async function categorizeFindings(availableCategories = []) {
            // ... (funci√≥n id√©ntica) ...
        }
        async function generateCompleteReport() {
            // ... (funci√≥n id√©ntica) ...
        }
        function teachFindingCategorization(finding, categoryId) {
            // ... (funci√≥n id√©ntica) ...
        }
        function displayCategorizedFindings() {
            // ... (funci√≥n id√©ntica) ...
        }

        const thoracicCategories = [0, 1, 2, 3, 4];
        const abdominalCategories = [5, 6, 7, 8, 9, 10, 11, 12];
        const otherCategories = [13];

        function updateAvailableCategories() {
            // ... (funci√≥n id√©ntica) ...
        }
        function updateContrastOptions() {
            // ... (funci√≥n id√©ntica) ...
        }
        function updateTechniqueDescription() {
            // ... (funci√≥n id√©ntica) ...
        }
        
        /*********************
         * EVENT LISTENERS
         *********************/
        document.addEventListener('DOMContentLoaded', () => {
            const sharedTheme = localStorage.getItem('sharedThemePreference');
            if (sharedTheme) {
                applyThemeJuanizador(sharedTheme);
                localStorage.setItem('themePreferenceJuanizador', sharedTheme); 
            } else {
                const savedTheme = localStorage.getItem('themePreferenceJuanizador') || 'light';
                applyThemeJuanizador(savedTheme);
            }
            
            transcriptArea = document.getElementById('transcript');
            const inputTextFromIndex = localStorage.getItem('juanizadorInputText');
            if (inputTextFromIndex) {
                transcriptArea.value = inputTextFromIndex;
                localStorage.removeItem('juanizadorInputText'); 
            }
            
            const backToDictationBtn = document.getElementById('backToDictationBtn');
            if (backToDictationBtn) { 
                backToDictationBtn.addEventListener('click', () => {
                    const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                    localStorage.setItem('sharedThemePreference', currentTheme);
                    window.location.href = 'index.html';
                });
            }
            
            // El resto de los listeners permanecen aqu√≠...
            const microphoneBtn = document.getElementById('microphone-btn');
            const categorizeBtn = document.getElementById('categorize-btn');
            const clearBtn = document.getElementById('clear-btn');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const copyReportBtn = document.getElementById('copy-report-btn');
            const imagingTechniqueSelect = document.getElementById('imaging-technique');
            const tacScopeSelect = document.getElementById('tac-scope');
            const rmTypeSelect = document.getElementById('rm-type');
            const contrastUseSelect = document.getElementById('contrast-use');
            
            initSpeechRecognition();
            updateAvailableCategories();
            
            imagingTechniqueSelect.addEventListener('change', updateAvailableCategories);
            tacScopeSelect.addEventListener('change', updateAvailableCategories);
            rmTypeSelect.addEventListener('change', updateTechniqueDescription);
            contrastUseSelect.addEventListener('change', updateContrastOptions);
            document.querySelectorAll('input[name="phase"]').forEach(cb => cb.addEventListener('change', updateTechniqueDescription));
            
            microphoneBtn.addEventListener('click', toggleRecording);
            categorizeBtn.addEventListener('click', () => categorizeFindings(window.availableCategories));
            
            clearBtn.addEventListener('click', () => {
                transcriptArea.value = '';
                document.getElementById('categorized-content').innerHTML = '';
                categorizedFindings = {};
            });
            
            generateReportBtn.addEventListener('click', generateCompleteReport);
            
            copyReportBtn.addEventListener('click', () => {
                const techniqueDescText = document.getElementById('technique-description').textContent;
                const reportText = document.getElementById('final-report').textContent;
                let fullText = "";
                if (techniqueDescText.trim()) {
                    fullText += techniqueDescText + "\n\n";
                }
                fullText += reportText;
                navigator.clipboard.writeText(fullText)
                    .then(() => alert('Informe copiado al portapapeles'))
                    .catch(err => console.error('Error al copiar: ', err));
            });
        });
    </script>
</body>
</html>
